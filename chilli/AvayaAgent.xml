<?xml version="1.0" ?>
<fsm name="avayaAgent" initial="init">
	<state id="init">
		<onentry>
		</onentry>
		<event event="logon" cond="_event.password == _agent.Password">
			<transition  target="logining"/>
		</event>
		<event event="logon">
			<send target="this" type="response" dest="client" event="logon">
				<status>1</status>
				<type>logon</type>
			</send>
		</event>
		<event event=".*">
			<send target="this" type="response" dest="client" eventexpr="_event._name">
				<status>1</status>
				<type type="script">_event._name;</type>
				<mem>未登录</mem>
			</send>
		</event>
		<state id="logining">
			<onentry>
				<send target="this" type="cmd" dest="this" event="AgentLogin">
					<deviceId type="script">_agent.avayaExtenion</deviceId>
					<password type="script">_agent.avayaPassword</password>
					<agentId type="script">_agent.avayaAgentId</agentId>
					<group type="script">_event.logingroups</group>
				</send>
			</onentry>
			<event event="AgentLogin" cond="_event.status==0">
				<transition  target="logined"/>
			</event>
			<event event="AgentLogin">
				<send target="this" type="response" dest="client" event="logon">
					<status type="script">_event.status</status>
					<type>logon</type>
				</send>
				<transition  target="init"/>
			</event>
			<event event=".*">
				<log level="warn" type="script">"not process event "+_event._name;</log>
			</event>
		</state>

		<state id="logined">
			<onentry>
				<send target="this" type="response" dest="client" event="logon">
					<status>0</status>
					<type>logon</type>
				</send>
			</onentry>
			<event event="ping">
				<log level="debug"> ping message</log>
			</event>
			<event event="ConnectError">
				<transition  target="init"/>
			</event>
			<event event="ConnectClose">
				<transition  target="init"/>
			</event>
			<event event="logout">
				<transition  target="init"/>
			</event>
			<event event="logon" cond="_event.password == _agent.Password">
				<send target="this" type="notify" dest="client" event="logon">
					<status>1</status>
					<type>logon</type>
				</send>
				<transition  target="logining"/>
			</event>
			<event event="logon">
				<send target="this" type="response" dest="client" event="logon">
					<status>1</status>
					<type>logon</type>
				</send>
			</event>
			<event event=".*">
				<log level="warn" type="script">"not process event "+_event._name;</log>
			</event>
		</state>
		
    </state>

</fsm>

