<?xml version="1.0" ?>
<fsm name="avayaAgent" initial="init">
<datamodel>
	<data id="connection"/>
</datamodel>
	<state id="init">
		<onentry>
			<send target="this" type="notify" dest="extension" event="AgentLogout">
				<event>AgentLogout</event>
				<AgentLogout type="script">var agentId={};agentId.agentId = _agent.AgentId; agentId = agentId;</AgentLogout>
				<extension type="script">_agent.Extension</extension>
			</send>
		</onentry>
		<event event="cmd" cond="_event.cmd=='logon' &amp;&amp; _event.password == _agent.Password">
			<transition  target="logining"/>
		</event>
		<event event="cmd" cond="_event.cmd=='logon'">
			<send target="this" type="response" dest="client" event="logon">
				<status>1</status>
				<type>logon</type>
			</send>
		</event>
		<event event="AgentLogout">
			<transition  target="init"/>
		</event>
		<event event="ACS_OPEN_STREAM_CONF" cond="_event.OpenStream.status==0">
		</event>
		<event event=".*">
			<send target="this" type="response" dest="client" eventexpr="_event._name">
				<status>1</status>
				<type type="script">_event.cmd;</type>
				<mem>未登录</mem>
			</send>
		</event>
		<state id="logining">
			<onentry>
				<send target="this" type="cmd" dest="this" event="AgentLogin">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
					<group type="script">_event.logingroups</group>
				</send>
				<send target="this" type="notify" dest="extension" event="AgentLogin">
					<event>AgentLogin</event>
					<AgentLogin type="script">var AgentLogin ={};AgentLogin.agentId = _agent.AgentId; AgentLogin;</AgentLogin>
					<extension type="script">_agent.Extension</extension>
				</send>
			</onentry>
			<event event="AgentLogin" cond="_event.AgentLogin.status==0">
				<transition  target="logined"/>
			</event>
			<event event="AgentLogin">
				<send target="this" type="response" dest="client" event="logon">
					<status type="script">_event.AgentLogin.status</status>
					<type>logon</type>
				</send>
				<transition  target="init"/>
			</event>
			<event event="ConnectError">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
				</send>
				<transition  target="init"/>
			</event>
			<event event="ConnectClose">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
				</send>
				<transition  target="init"/>
			</event>
			<event event="cmd" cond="_event.cmd=='logout'">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
					<group type="script">_event.logingroups</group>
				</send>
				<transition  target="init"/>
			</event>
			<event event="cmd" cond="_event.cmd=='ping'">
				<log level="debug"> ping message</log>
			</event>
			<event event=".*">
				<log level="warn" type="script">_state._id + " not process event "+_event._name;</log>
			</event>
			<state id="logined">
				<onentry>
					<send target="this" type="response" dest="client" event="logon">
						<status>0</status>
						<type>logon</type>
					</send>
					<send target="this" type="cmd" dest="this" event="AgentGetState">
						<deviceId type="script">_avaya.Extension</deviceId>
					</send>
				</onentry>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='NotReady'">
					<send target="this" type="notify" dest="client" event="agentbusy">
						<status type="script">0;</status>
						<type>agentbusy</type>
					</send>
					<transition  target="NotReady"/>
				</event>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='Ready'">
					<send target="this" type="notify" dest="client" event="agentidle">
						<status type="script">0;</status>
						<type>agentidle</type>
					</send>
					<transition  target="Ready"/>
				</event>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='Null'">
					<transition  target="Null"/>
				</event>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='WorkNotReady'">
					<send target="this" type="notify" dest="client" event="agentbusy">
						<status type="script">0;</status>
						<type>agentbusy</type>
					</send>
					<transition  target="WorkNotReady"/>
				</event>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='WorkReady'">
					<send target="this" type="notify" dest="client" event="agentbusy">
						<status type="script">0;</status>
						<type>agentbusy</type>
					</send>
					<transition  target="WorkReady"/>
				</event>
				<event event="cmd" cond="_event.cmd=='logon' &amp;&amp; _event.password == _agent.Password">
					<send target="this" type="notify" dest="client" event="logon">
						<status>1</status>
						<type>logon</type>
					</send>
					<transition  target="logining"/>
				</event>
				<event event="cmd" cond="_event.cmd=='logon'">
					<send target="this" type="response" dest="client" event="logon">
						<status>1</status>
						<type>logon</type>
					</send>
				</event>
				<event event="cmd" cond="_event.cmd=='agentidle'">
					<send target="this" type="cmd" dest="this" event="AgentSetFree">
						<deviceId type="script">_avaya.Extension</deviceId>
						<agentId type="script">_avaya.AgentId</agentId>
					</send>
				</event>
				<event event="AgentSetFree">
					<send target="this" type="notify" dest="client" event="agentidle">
						<status type="script"> _event.AgentSetFree.status</status>
						<type>agentidle</type>
					</send>
					<transition cond="_event.AgentSetFree.status==0" target="Ready"/>
				</event>
				<event event="DELIVERED" cond="_event.delivered.localConnect == 'Alerting'">
					<send target="this" type="notify" dest="client" event="inringing">
						<type>inringing</type>
						<callid type="script">_event.delivered.connection.callID;</callid>
						<timestamp type="script">Date.parse(new Date()); </timestamp>
						<caller type="script">_event.delivered.calling; </caller>
						<called type="script">_event.delivered.called;</called>
						<nowgroupid type="script"> -1;</nowgroupid>
					</send>
					<script>connection = _event.delivered.connection;</script>
					<transition  target="inringing"/>
				</event>
				<event event="DELIVERED" cond="_event.delivered.localConnect == 'Connect'">
					<send target="this" type="notify" dest="client" event="calledringing">
						<type>calledringing</type>
						<callid type="script">_event.delivered.connection.callID;</callid>
						<timestamp type="script">Date.parse(new Date()); </timestamp>
						<caller type="script">_event.delivered.calling; </caller>
						<called type="script">_event.delivered.called;</called>
						<nowgroupid type="script"> -1;</nowgroupid>
					</send>
					<script>connection = _event.delivered.connection;</script>
					<transition  target="calledringing"/>
				</event>
				<event event="cmd" cond="_event.cmd=='makecall'">
					<send target="this" type="cmd" dest="this" event="MakeCall">
						<calling type="script">_agent.Extension;</calling>
						<called type="script">_event.called;</called>
					</send>
				</event>
				<event event="MakeCall">
					<send target="this" type="notify" dest="client" event="makecall">
						<status type="script">_event.MakeCall.status;</status>
						<type>makecall</type>
						<reason type="script">_event.MakeCall.reason;</reason>
					</send>
				</event>
				<state id="NotReady">
				</state>
				<state id="Ready">
					<event event="cmd" cond="_event.cmd=='agentbusy'">
						<send target="this" type="cmd" dest="this" event="AgentSetBusy">
							<deviceId type="script">_avaya.Extension</deviceId>
							<agentId type="script">_avaya.AgentId</agentId>
						</send>
					</event>
					<event event="AgentSetBusy">
						<send target="this" type="notify" dest="client" event="agentbusy">
							<status type="script">_event.AgentSetBusy.status</status>
							<type>agentbusy</type>
						</send>
						<transition  cond="_event.status==0" target="NotReady"/>
					</event>
				</state>
				<state id="Null">
				</state>
				<state id="WorkNotReady">
				</state>
				<state id="WorkReady">
				</state>
				<state id="inringing">
					<event event="ESTABLISHED">
						<send target="this" type="notify" dest="client" event="incall">
							<type>incall</type>
							<callid type="script">_event.established.connection.callID;</callid>
							<called type="script">_event.established.called;</called>
						</send>
						<transition target="incall"/>
					</event>
					<event event="CONNECTION_CLEARED">
						<send target="this" type="notify" dest="client" event="after">
							<type>after</type>
							<callid type="script">_event.connectionCleared.connection.callID;</callid>
							<called type="script">_agent.Extension;</called>
						</send>
						<transition target="after"/>
					</event>
					<event event="cmd" cond="_event.cmd=='cancelmakecall'">
						<send target="this" type="cmd" dest="this" event="ClearCall">
							<connection type="script">connection;</connection>
						</send>
					</event>
					<event event="cmd" cond="_event.cmd=='answercall'">
						<send target="this" type="cmd" dest="this" event="AnswerCall">
							<connection type="script">connection;</connection>
						</send>
					</event>
					<state id="incall">
						<event event="cmd" cond="_event.cmd=='cancelmakecall'">
							<send target="this" type="cmd" dest="this" event="ClearConnection">
								<connection type="script">connection;</connection>
							</send>
						</event>
					</state>
				</state>
				<state id="after">
				</state>
				<state id ="calledringing">
					<event event="ESTABLISHED">
						<send target="this" type="notify" dest="client" event="answer">
							<type>answer</type>
							<callid type="script">_event.established.connection.callID;</callid>
							<called type="script">_event.established.called;</called>
						</send>
						<transition target="answer"/>
					</event>
					<event event="cmd" cond="_event.cmd=='cancelmakecall'">
						<send target="this" type="cmd" dest="this" event="ClearCall">
							<connection type="script">connection;</connection>
						</send>
					</event>
					<event event="CONNECTION_CLEARED">
						<send target="this" type="notify" dest="client" event="after">
							<type>after</type>
							<callid type="script">_event.connectionCleared.connection.callID;</callid>
							<called type="script">_agent.Extension;</called>
						</send>
						<transition target="after"/>
					</event>
					<state id="answer">
						<event event="cmd" cond="_event.cmd=='cancelmakecall'">
							<send target="this" type="cmd" dest="this" event="ClearConnection">
								<connection type="script">connection;</connection>
							</send>
						</event>
					</state>
				</state>
			</state>
		</state>

		
    </state>

</fsm>

