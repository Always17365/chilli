<?xml version="1.0" ?>
<fsm name="avayaAgent" initial="init">
	<state id="init">
		<onentry>
		</onentry>
		<event event="cmd" cond="_event.cmd=='logon' &amp;&amp; _event.password == _agent.Password">
			<transition  target="logining"/>
		</event>
		<event event="cmd" cond="_event.cmd=='logon'">
			<send target="this" type="response" dest="client" event="logon">
				<status>1</status>
				<type>logon</type>
			</send>
		</event>
		<event event="AgentLogout">
			<transition  target="init"/>
		</event>
		<event event="ACS_OPEN_STREAM_CONF" cond="_event.status==0">
		</event>
		<event event=".*">
			<send target="this" type="response" dest="client" eventexpr="_event._name">
				<status>1</status>
				<type type="script">_event.cmd;</type>
				<mem>未登录</mem>
			</send>
		</event>
		<state id="logining">
			<onentry>
				<send target="this" type="cmd" dest="this" event="AgentLogin">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
					<group type="script">_event.logingroups</group>
				</send>
			</onentry>
			<event event="AgentLogin" cond="_event.status==0">
				<send target="this" type="notify" dest="extension" event="AgentLogin">
					<event>AgentLogin</event>
					<agentId type="script">_agent.AgentId</agentId>
					<extension type="script">_agent.Extension</extension>
					<status type="script">_event.status</status>
				</send>
				<transition  target="logined"/>
			</event>
			<event event="AgentLogin">
				<send target="this" type="response" dest="client" event="logon">
					<status type="script">_event.status</status>
					<type>logon</type>
				</send>
				<transition  target="init"/>
			</event>
			<event event="ConnectError">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
				</send>
				<transition  target="init"/>
			</event>
			<event event="ConnectClose">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
				</send>
				<transition  target="init"/>
			</event>
			<event event="cmd" cond="_event.cmd=='logout'">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
					<group type="script">_event.logingroups</group>
				</send>
				<transition  target="init"/>
			</event>
			<event event="cmd" cond="_event.cmd=='ping'">
				<log level="debug"> ping message</log>
			</event>
			<event event=".*">
				<log level="warn" type="script">_state._id + " not process event "+_event._name;</log>
			</event>
			<state id="logined">
				<onentry>
					<send target="this" type="response" dest="client" event="logon">
						<status>0</status>
						<type>logon</type>
					</send>
					<send target="this" type="cmd" dest="this" event="AgentGetState">
						<deviceId type="script">_avaya.Extension</deviceId>
					</send>
				</onentry>
				<event event="AgentGetState" cond="_event.agentState=='NotReady'">
					<transition  target="NotReady"/>
				</event>
				<event event="AgentGetState" cond="_event.agentState=='Ready'">
					<transition  target="Ready"/>
				</event>
				<event event="AgentGetState" cond="_event.agentState=='Null'">
					<transition  target="Null"/>
				</event>
				<event event="AgentGetState" cond="_event.agentState=='WorkNotReady'">
					<transition  target="WorkNotReady"/>
				</event>
				<event event="AgentGetState" cond="_event.agentState=='WorkReady'">
					<transition  target="WorkReady"/>
				</event>
				<event event="cmd" cond="_event.cmd=='logon' &amp;&amp; _event.password == _agent.Password">
					<send target="this" type="notify" dest="client" event="logon">
						<status>1</status>
						<type>logon</type>
					</send>
					<transition  target="logining"/>
				</event>
				<event event="cmd" cond="_event.cmd=='logon'">
					<send target="this" type="response" dest="client" event="logon">
						<status>1</status>
						<type>logon</type>
					</send>
				</event>
				<state id="NotReady">
					<event event="cmd" cond="_event.cmd=='agentidle'">
						<send target="this" type="cmd" dest="this" event="AgentSetFree">
							<deviceId type="script">_avaya.Extension</deviceId>
							<agentId type="script">_avaya.AgentId</agentId>
						</send>
					</event>
					<event event="AgentSetFree">
						<send target="this" type="notify" dest="client" event="agentidle">
							<status type="script"> _event.status</status>
							<type>agentidle</type>
						</send>
						<transition cond="_event.status==0" target="Ready"/>
					</event>
				</state>
				<state id="Ready">
					<event event="cmd" cond="_event.cmd=='agentbusy'">
						<send target="this" type="cmd" dest="this" event="AgentSetBusy">
							<deviceId type="script">_avaya.Extension</deviceId>
							<agentId type="script">_avaya.AgentId</agentId>
						</send>
					</event>
					<event event="AgentSetBusy">
						<send target="this" type="notify" dest="client" event="agentbusy">
							<status type="script">_event.status</status>
							<type>agentbusy</type>
						</send>
						<transition  cond="_event.status==0" target="NotReady"/>
					</event>
				</state>
				<state id="Null">
				</state>
				<state id="WorkNotReady">
				</state>
				<state id="WorkReady">
				</state>
			</state>
		</state>

		
    </state>

</fsm>

