<?xml version="1.0" ?>

<fsm name ="AvayaExtension" initial="init">
<datamodel>
	<data id="agentId" expr="''"/>
	<date id="connection"/>
	<date id="newCall"/>
</datamodel>
<scriptmodel>
	<script src="./conf/cmpObject.js" />
</scriptmodel>
	<state id="init">
		<event event="AgentLogin" cond="_event.AgentLogin.agentId != ''">
			<script>agentId = _event.AgentLogin.agentId;</script>	
		</event>
		
		<event event="AgentLogin">
			<send target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<extension type="script">_event.agentId;</extension>
				<AgentLogin type="script">_event.AgentLogin.status = 1; _event.AgentLogin;</AgentLogin>
			</send>
		</event>
		
		<event event="AgentLogout" cond="agentId == _event.AgentLogout.agentId">
			<script>agentId = '';</script>
		</event>
		
		<event event="SERVICE_INITIATED">
			<script>connection = _event.serviceInitiated.connection;</script>
			<transition target="serviceInitiated"/>
		</event>
		<event event ="DELIVERED">
			<script>connection = _event.delivered.connection;</script>
			<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<extension type="script">agentId;</extension>
				<monitorId type="script">_event.monitorId;</monitorId>
				<delivered type="script">_event.delivered;</delivered>
			</send>
			<transition target="Alerting"/>
		</event>
		<event event ="CONNECTION_CLEARED">
			<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<extension type="script">agentId;</extension>
				<monitorId type="script">_event.monitorId;</monitorId>
				<connectionCleared type="script">_event.connectionCleared;</connectionCleared>
			</send>
			<transition cond="cmp(_event.connectionCleared.connection,connection)" target="init"/>
		</event>
		<event event ="CALL_CLEARED">
			<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<extension type="script">agentId;</extension>
				<monitorId type="script">_event.monitorId;</monitorId>
				<connectionCleared type="script">_event.callCleared;</connectionCleared>
			</send>
			<transition cond="cmp(_event.callCleared.connection,connection)" target="init"/>
		</event>
		<state id="serviceInitiated">
			<event event="ORIGINATED">
				<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
					<event type="script">_event._name;</event>
					<extension type="script">agentId;</extension>
					<monitorId type="script">_event.monitorId;</monitorId>
					<originated type="script">_event.originated;</originated>
				</send>
				<transition cond="cmp(_event.originated.connection,connection)" target="originated"/>
			</event>
			<event event="FAILED">
				<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
					<event type="script">_event._name;</event>
					<extension type="script">agentId;</extension>
					<monitorId type="script">_event.monitorId;</monitorId>
					<failed type="script">_event.failed;</failed>
				</send>
			</event>
			<state id="originated">
				<event event ="DELIVERED">
					<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
						<event type="script">_event._name;</event>
						<extension type="script">agentId;</extension>
						<monitorId type="script">_event.monitorId;</monitorId>
						<delivered type="script">_event.delivered;</delivered>
					</send>
					<transition cond="_event.delivered.connection.callID == connection.callID" target="delivered"/>
				</event>
				<event event ="ESTABLISHED">
					<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
						<event type="script">_event._name;</event>
						<extension type="script">agentId;</extension>
						<monitorId type="script">_event.monitorId;</monitorId>
						<established type="script">_event.established;</established>
					</send>
					<transition cond="_event.established.connection.callID == connection.callID" target="established"/>
				</event>
				<state id="delivered">
					
				</state>
			</state>
			
		</state>

		<state id ="Alerting">
			<event event ="ESTABLISHED">
				<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
					<event type="script">_event._name;</event>
					<extension type="script">agentId;</extension>
					<monitorId type="script">_event.monitorId;</monitorId>
					<established type="script">_event.established;</established>
				</send>
				<transition cond="cmp(_event.established.connection,connection)" target="established"/>
			</event>
		</state>
		
		<state id="established">
			<event event="HELD">
				<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
					<event type="script">_event._name;</event>
					<extension type="script">agentId;</extension>
					<monitorId type="script">_event.monitorId;</monitorId>
					<held type="script">_event.held;</held>
				</send>
				<transition cond="cmp(_event.held.connection,connection)" target="held"/>
				<transition cond="_event.held.connection.callID == connection.callID" target="helded"/>
			</event>
			<state id="held">
				<event event="RETRIEVED">
					<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
						<event type="script">_event._name;</event>
						<extension type="script">agentId;</extension>
						<monitorId type="script">_event.monitorId;</monitorId>
						<retrieved type="script">_event.retrieved;</retrieved>
					</send>
					<transition cond="cmp(_event.retrieved.connection,connection)" target="established"/>
				</event>
				<event event="HELD">
					<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
						<event type="script">_event._name;</event>
						<extension type="script">agentId;</extension>
						<monitorId type="script">_event.monitorId;</monitorId>
						<held type="script">_event.held;</held>
					</send>
					<transition cond="_event.held.connection.callID == connection.callID" target="heldedAndheld"/>
				</event>
				<event event="SERVICE_INITIATED">
					<script>newCall = _event.serviceInitiated.connection;</script>
					<transition target="heldAndserviceInitiated"/>
				</event>
				<state id="heldAndserviceInitiated">
					<event event="FAILED">
						<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
							<event type="script">_event._name;</event>
							<extension type="script">agentId;</extension>
							<monitorId type="script">_event.monitorId;</monitorId>
							<failed type="script">_event.failed;</failed>
						</send>
					</event>
					<event event="HELD" cond="cmp(_event.held.connection,newCall)">
					</event>
					<event event="ORIGINATED">
						<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
							<event type="script">_event._name;</event>
							<extension type="script">agentId;</extension>
							<monitorId type="script">_event.monitorId;</monitorId>
							<originated type="script">_event.originated;</originated>
						</send>
						<transition cond="cmp(_event.originated.connection,newCall)" target="heldAndoriginated"/>
					</event>
					<state id="heldAndoriginated">
						<event event="DELIVERED">
							<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
								<event type="script">_event._name;</event>
								<extension type="script">agentId;</extension>
								<monitorId type="script">_event.monitorId;</monitorId>
								<delivered type="script">_event.delivered;</delivered>
							</send>
							<transition cond="_event.delivered.connection.callID == newCall.callID" target="heldAnddelivered"/>
						</event>
					</state>
					<state id="heldAnddelivered">
						<event event="TRANSFERRED">
							<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
								<event type="script">_event._name;</event>
								<extension type="script">agentId;</extension>
								<monitorId type="script">_event.monitorId;</monitorId>
								<transferred type="script">_event.transferred;</transferred>
							</send>
							<transition target="init"/>
						</event>
						<event event="ESTABLISHED" cond="_event.established.connection.callID == newCall.callID">
							<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
								<event type="script">_event._name;</event>
								<extension type="script">agentId;</extension>
								<monitorId type="script">_event.monitorId;</monitorId>
								<established type="script">_event.established;</established>
							</send>
							<transition target="heldAndestablished"/>
						</event>
						<state id="heldAndestablished">
							<event event="CONFERENCED">
								<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
									<event type="script">_event._name;</event>
									<extension type="script">agentId;</extension>
									<monitorId type="script">_event.monitorId;</monitorId>
									<conferenced type="script">_event.conferenced;</conferenced>
								</send>
								<script>connection = _event.conferenced.secondaryOldCall;</script>
								<transition target="conferenced"/>
							</event>
							<state id="conferenced">
								
							</state>
						</state>
					</state>
				</state>
			</state>
			<state id="helded">
				<event event="RETRIEVED">
					<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
						<event type="script">_event._name;</event>
						<extension type="script">agentId;</extension>
						<monitorId type="script">_event.monitorId;</monitorId>
						<retrieved type="script">_event.retrieved;</retrieved>
					</send>
					<transition cond="_event.retrieved.connection.callID == connection.callID" target="established"/>
				</event>
				<event event="HELD">
					<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
						<event type="script">_event._name;</event>
						<extension type="script">agentId;</extension>
						<monitorId type="script">_event.monitorId;</monitorId>
						<held type="script">_event.held;</held>
					</send>
					<transition cond="cmp(_event.held.connection,connection)" target="heldedAndheld"/>
				</event>
			</state>
			<state id="heldedAndheld">
				<event event="RETRIEVED">
					<send cond="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
						<event type="script">_event._name;</event>
						<extension type="script">agentId;</extension>
						<monitorId type="script">_event.monitorId;</monitorId>
						<retrieved type="script">_event.retrieved;</retrieved>
					</send>
					<transition cond="cmp(_event.retrieved.connection,connection)" target="helded"/>
					<transition cond="_event.retrieved.connection.callID == connection.callID" target="held"/>
				</event>
			</state>
		</state>
		<!--event event="timer">
			<log level="debug" type="script">_event.id;</log>
			<send target="this" type="cmd" dest="this" event="MonitorStop">
				<monitorId type="script">monitorId</monitorId>
			</send>
		</event-->

    </state>
</fsm>

