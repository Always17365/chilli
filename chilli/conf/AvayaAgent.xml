<?xml version="1.0" ?>
<fsm name="avayaAgent" initial="init" final="final">
<datamodel>
	<data id="connection"/>
	<data id="consultationNewCall"/>
	<date id="conferenceCall"/>
	<date id="called"/>
	<data id="callUUID"/>
	<data id="timestamp"/>
	<data id="starttime"/>
</datamodel>
<scriptmodel>
	<script src="./conf/cmpObject.js" />
	<script src="./conf/uuid.js" />
	<script src="./conf/DateFormat.js"/>
</scriptmodel>
	<state id="init">
		<event event="cmd" cond="_event.cmd=='logon'">
			<transition  target="logining"/>
		</event>
		<event event="cmd" cond="_event.cmd=='logon'">
			<send target="this" type="response" dest="client" event="logon">
				<status>1</status>
				<type>logon</type>
			</send>
		</event>
		<event event="AgentLogout">
			<transition  target="final"/>
		</event>
		<event event=".*">
			<send target="this" type="response" dest="client" eventexpr="_event._name">
				<status>1</status>
				<type type="script">_event.cmd;</type>
				<mem>未登录</mem>
			</send>
		</event>
		<state id="logining">
			<onentry>
				<send target="this" type="cmd" dest="this" event="AgentLogin">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
					<group type="script">_event.logingroups</group>
				</send>
				<send target="this" type="notify" dest="extension" event="AgentLogin">
					<event>AgentLogin</event>
					<AgentLogin type="script">var AgentLogin ={};AgentLogin.agentId = _agent.AgentId; AgentLogin;</AgentLogin>
					<extension type="script">_agent.Extension</extension>
				</send>
			</onentry>
			<event event="AgentLogout" cond="_event.AgentLogout.cause==0">
				<transition target="logining"/>
			</event>
			<event event="AgentLogout">
				<send target="this" type="response" dest="client" event="logon">
					<status type="script">_event.AgentLogout.cause</status>
					<type>logon</type>
					<reason type="script">_event.AgentLogout.reason</reason>
				</send>
				<transition  target="final"/>
			</event>
			<event event="AgentLogin" cond="_event.AgentLogin.cause==0">
				<transition  target="logined"/>
			</event>
			<event event="AgentLogin" cond="_event.AgentLogin.cause==1001">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
				</send>
			</event>
			<event event="AgentLogin">
				<send target="this" type="response" dest="client" event="logon">
					<status type="script">_event.AgentLogin.cause</status>
					<type>logon</type>
					<reason type="script">_event.AgentLogin.reason</reason>
				</send>
				<transition  target="final"/>
			</event>
			<event event="ConnectError">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
				</send>
				<transition target="logouting"/>
			</event>
			<event event="ConnectClose">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
				</send>
				<transition target="logouting"/>
			</event>
			<event event="cmd" cond="_event.cmd=='logout'">
				<send target="this" type="cmd" dest="this" event="AgentLogout">
					<deviceId type="script">_avaya.Extension</deviceId>
					<password type="script">_avaya.Password</password>
					<agentId type="script">_avaya.AgentId</agentId>
					<group type="script">_event.logingroups</group>
				</send>
				<transition target="logouting"/>
			</event>
			<event event="cmd" cond="_event.cmd=='ping'">
				<log level="trace"> ping message</log>
			</event>
			<event event=".*">
				<log level="warn" type="script">_state._id + " not process event "+_event._name;</log>
			</event>
			<state id="logined">
				<onentry>
					<send target="this" type="response" dest="client" event="logon">
						<status type="script">0</status>
						<type>logon</type>
					</send>
					<send target="this" type="cmd" dest="this" event="AgentGetState">
						<deviceId type="script">_avaya.Extension</deviceId>
					</send>
				</onentry>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='NotReady'">
					<send target="this" type="notify" dest="client" event="agentbusy">
						<status type="script">0;</status>
						<type>agentbusy</type>
					</send>
					<transition  target="NotReady"/>
				</event>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='Ready'">
					<send target="this" type="notify" dest="client" event="agentidle">
						<status type="script">0;</status>
						<type>agentidle</type>
					</send>
					<transition  target="Ready"/>
				</event>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='Null'">
					<transition  target="Null"/>
				</event>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='WorkNotReady'">
					<send target="this" type="notify" dest="client" event="agentbusy">
						<status type="script">0;</status>
						<type>agentbusy</type>
					</send>
					<transition  target="WorkNotReady"/>
				</event>
				<event event="AgentGetState" cond="_event.AgentGetState.agentState=='WorkReady'">
					<send target="this" type="notify" dest="client" event="agentbusy">
						<status type="script">0;</status>
						<type>agentbusy</type>
					</send>
					<transition  target="WorkReady"/>
				</event>
				<event event="cmd" cond="_event.cmd=='logon'">
					<send target="this" type="notify" dest="client" event="kick">
						<status>1</status>
						<type>kick</type>
						<reason>账号在其他地方登陆</reason>
					</send>
					<transition  target="logining"/>
				</event>
				<event event="cmd" cond="_event.cmd=='agentidle'">
					<send target="this" type="cmd" dest="this" event="AgentSetFree">
						<deviceId type="script">_avaya.Extension</deviceId>
						<agentId type="script">_avaya.AgentId</agentId>
					</send>
				</event>
				<event event="AgentSetFree">
					<send target="this" type="notify" dest="client" event="agentidle">
						<status type="script"> _event.AgentSetFree.cause</status>
						<type>agentidle</type>
					</send>
					<transition cond="_event.AgentSetFree.cause==0" target="Ready"/>
				</event>
				<event event="DELIVERED">
					<script>connection = _event.delivered.connection; called = _event.delivered.called;</script>
					<send target="this" type="notify" dest="client" event="inringing">
						<type>inringing</type>
						<callid type="script">_event.delivered.connection.callID;</callid>
						<timestamp type="script">Date.parse(new Date())/1000; </timestamp>
						<caller type="script">_event.delivered.calling; </caller>
						<called type="script">called;</called>
						<userdata type="script">_event.delivered.userdata;</userdata>
						<nowgroupid type="script"> -1;</nowgroupid>
					</send>
					<transition  target="Alerting"/>
				</event>
				<event event="CONNECTION_CLEARED">
					<transition cond="cmp(_event.connectionCleared.connection,connection)" target="ACW"/>
				</event>
				<event event="CALL_CLEARED">
					<transition cond="cmp(_event.callCleared.connection,connection)" target="ACW"/>
				</event>
				<event event="cmd" cond="_event.cmd=='makecall'">
					<send target="this" type="cmd" dest="this" event="MakeCall">
						<calling type="script">_agent.Extension;</calling>
						<called type="script">_event.called;</called>
					</send>
					<script>called = _event.called;</script>
					<transition target="makecalling"/>
				</event>
				
				<event event="SQL">
					<log level="trace">execute sql result</log>
				</event>
				<state id="makecalling">
					<event event="cmd" cond="_event.cmd=='makecall'"/>
					<event event="MakeCall">
						<script>
						if(_event.MakeCall.cause ==0)
							connection = _event.MakeCall.newCall;
						else{
							connection = {};
							connection.callID =0;
						}
						</script>
						<script>callUUID = uuid(); timestamp = new Date(); starttime = new Date();</script>
						
						<send cond="_event.MakeCall.cause !=0" fromexpr="_agent.AgentId" target="mysql" type="cmd" dest="mysql"  event="sql">
							<sql type="script">var sql='INSERT INTO call_cdr'+
							'(id,                      callid,                      device,                  companyid,                    agentid,                  caller,                     called,              origcaller,             origcalled,      start_stamp,           direction, createtime,              owner, cdrtype,  timestamp,            devicetype,  callid_stamp_str,                                 mediano) VALUES'+
							'(\'' + callUUID+'\',\''+ connection.callID +'\',\'' + _agent.Extension+ '\','+_extension.companyid + ',\'' + _agent.AgentId + '\',\'' +_agent.Extension + '\',\'' + called +'\',\'' + _agent.Extension +'\',\'' + called + '\',' + Date.parse(starttime) / 1000+ ',1,' +   Date.parse(new Date())/1000 + ',3,      0,' +  Date.parse(timestamp)/1000 + ',1,\'' +  timestamp.Format('yyyy-MM-dd HH:mm:ss') + '\',' + _stationNo+ ')';
							sql;</sql>
						</send>
						
						<send cond="_event.MakeCall.cause !=0" fromexpr="_agent.AgentId" target="mysql" type="cmd" dest="mysql"  event="sql">
							<sql type="script">var sql='UPDATE call_cdr SET end_stamp=' + Date.parse(new Date())/1000+ ', hangup_cause=\'' + _event.MakeCall.cause + '\',hangupdir=0  where id=\'' + callUUID + '\''; sql;</sql>
						</send>
						
						<send target="this" type="notify" dest="client" event="makecall">
							<status type="script">_event.MakeCall.cause;</status>
							<type>makecall</type>
							<reason type="script">_event.MakeCall.reason;</reason>
						</send>
						<transition cond="_event.MakeCall.cause !=0" target="ACW"/>
					</event>
					<event event="SERVICE_INITIATED">
						<send target="this" type="notify" dest="client" event="outringing">
							<type>outringing</type>
							<called type="script">called;</called>
							<caller type="script">_agent.Extension;</caller>
							<callid type="script">_event.serviceInitiated.connection.callID;</callid>
							<nowgroupid type="script">1</nowgroupid>
							<timestamp type="script">Date.parse(new Date())/1000; </timestamp>
						</send>
					</event>
					<event event="ORIGINATED">
						<script>connection = _event.originated.connection;</script>
						<transition target="originated"/>
					</event>
					<event event="cmd" cond="_event.cmd=='cancelmakecall'">
						<send target="this" type="cmd" dest="this" event="ClearCall">
							<connection type="script">connection;</connection>
						</send>
					</event>
				</state>
				<state id="NotReady">
				</state>
				<state id="Ready">
					<event event="cmd" cond="_event.cmd=='agentbusy'">
						<send target="this" type="cmd" dest="this" event="AgentSetBusy">
							<deviceId type="script">_avaya.Extension</deviceId>
							<agentId type="script">_avaya.AgentId</agentId>
						</send>
					</event>
					<event event="AgentSetBusy">
						<send target="this" type="notify" dest="client" event="agentbusy">
							<status type="script">_event.AgentSetBusy.cause</status>
							<type>agentbusy</type>
						</send>
						<transition  cond="_event.AgentSetBusy.cause==0" target="NotReady"/>
					</event>
					<event event="ORIGINATED">
						<script>connection = _event.originated.connection; called = _event.originated.called;</script>
						<transition target="originated"/>
					</event>
				</state>
				<state id="Null">
				</state>
				<state id="WorkNotReady">
				</state>
				<state id="WorkReady">
				</state>
				<state id="originated">
					<onentry>
						<send target="this" type="notify" dest="client" event="outcall">
							<type>outcall</type>
							<callid type="script">_event.originated.connection.callID;</callid>
							<called type="script">called;</called>
						</send>
						<send target="this" type="notify" dest="client" event="calledringing">
							<type>calledringing</type>
							<callid type="script">_event.originated.connection.callID;</callid>
							<timestamp type="script">Date.parse(new Date())/1000; </timestamp>
							<caller type="script">_event.originated.calling; </caller>
							<called type="script">called;</called>
							<nowgroupid type="script"> -1;</nowgroupid>
						</send>
					</onentry>
					<event event="DELIVERED">
						<send target="this" type="notify" dest="client" event="calledringing">
							<type>calledringing</type>
							<callid type="script">_event.delivered.connection.callID;</callid>
							<timestamp type="script">Date.parse(new Date())/1000; </timestamp>
							<caller type="script">_event.delivered.calling; </caller>
							<called type="script">called;</called>
							<nowgroupid type="script"> -1;</nowgroupid>
						</send>
						<transition  cond="_event.delivered.connection.callID == connection.callID" target="delivered"/>
					</event>
					<event event="cmd" cond="_event.cmd=='cancelmakecall'">
						<send target="this" type="cmd" dest="this" event="ClearCall">
							<connection type="script">connection;</connection>
						</send>
					</event>
					<event event="FAILED">
					</event>
					<event event="ClearCall">
					</event>
					<event event="ESTABLISHED">
						<send target="this" type="notify" dest="client" event="answer">
							<type>answer</type>
							<callid type="script">_event.established.connection.callID;</callid>
							<called type="script">called;</called>
						</send>
						<transition cond="_event.established.connection.callID == connection.callID" target="established"/>
					</event>
					<state id ="delivered">
					</state>
				</state>
				<state id="Alerting">
					<event event="ESTABLISHED">
						<send target="this" type="notify" dest="client" event="incall">
							<type>incall</type>
							<callid type="script">_event.established.connection.callID;</callid>
							<called type="script">called;</called>
						</send>
						<transition cond="cmp(_event.established.connection,connection)" target="established"/>
					</event>
					<event event="cmd" cond="_event.cmd=='cancelmakecall'">
						<send target="this" type="cmd" dest="this" event="ClearCall">
							<connection type="script">connection;</connection>
						</send>
					</event>
					<event event="cmd" cond="_event.cmd=='answercall'">
						<send target="this" type="cmd" dest="this" event="AnswerCall">
							<connection type="script">connection;</connection>
						</send>
					</event>
				</state>
				<state id="ACW">
					<onentry>
						<send target="this" type="notify" dest="client" event="after">
							<type>after</type>
							<callid type="script">connection.callID;</callid>
							<called type="script">called;</called>
						</send>
					</onentry>
					<event event="ORIGINATED">
						<script>connection = _event.originated.connection; called = _event.originated.called;</script>
						<transition target="originated"/>
					</event>
				</state>
				<state id="established">
					<event event="cmd" cond="_event.cmd=='makecall'">
					</event>
					<event event="cmd" cond="_event.cmd=='cancelmakecall'">
						<send target="this" type="cmd" dest="this" event="ClearCall">
							<connection type="script">connection;</connection>
						</send>
					</event>
					<event event="cmd" cond="_event.cmd=='mute'">
						<send target="this" type="cmd" dest="this" event="HoldCall">
							<connection type="script">connection;</connection>
						</send>
						<transition target="helding"/>
					</event>
					<event event="RETRIEVED">
						<transition cond="cmp(_event.retrieved.connection,connection)" target="established"/>
					</event>
					<event event="cmd" cond="_event.cmd=='agentconsult'">
						<send target="this" type="cmd" dest="this" event="ConsultationCall">
							<connection type="script">connection;</connection>
							<called type="script">_event.num;</called>
						</send>
						<transition target="consultationing"/>
					</event>
					<event event="cmd" cond="_event.cmd=='transfercall'">
						<send target="this" type="cmd" dest="this" event="ConsultationCall">
							<connection type="script">connection;</connection>
							<called type="script">_event.num;</called>
						</send>
						<transition target="transfering"/>
					</event>
					<state id="transfering">
						<event event="ConsultationCall" >
							<send target="this" type="notify" dest="client" event="transfercall">
								<type>transfercall</type>
								<status type="script">_event.ConsultationCall.cause;</status>
								<reason type="script">_event.ConsultationCall.reason; </reason>
							</send>
							<script>consultationNewCall = _event.ConsultationCall.newCall;</script>

							<send target="this" type="cmd" dest="this" event="TransferCall">
								<activeCall type="script">consultationNewCall;</activeCall>
								<heldCall type="script">connection;</heldCall>
							</send>
							
							<transition cond = "_event.ConsultationCall.cause != 0" target="established"/>
							
						</event>
						<event event="HELD">
						</event>
						<event event="DELIVERED">
						</event>
						<event event="FAILED">
							<send target="this" type="cmd" dest="this" event="ClearCall">
								<connection type="script">_event.failed.connection;</connection>
							</send>
							<send target="this" type="cmd" dest="this" event="ClearCall">
								<connection type="script">connection;</connection>
							</send>
						</event>
						<event event="ORIGINATED" cond="cmp(_event.originated.connection,consultationNewCall)">
						</event>
						
						<event event="TransferCall" cond="_event.TransferCall.cause==0">
						</event>
						
						<event event="TransferCall">
							<send target="this" type="cmd" dest="this" event="ClearCall">
								<connection type="script">connection;</connection>
							</send>
							<send target="this" type="cmd" dest="this" event="ClearCall">
								<connection type="script">consultationNewCall;</connection>
							</send>
						</event>
						<event event ="TRANSFERRED">
							<transition target="ACW"/>
						</event>
						<event event="CONNECTION_CLEARED" cond="cmp(_event.connectionCleared.connection,consultationNewCall)">
						</event>
						<event event="RETRIEVED" >
							<transition cond="cmp(_event.retrieved.connection, connection)" target="established"/>
						</event>
					</state>
					<state id="consultationing">
					
						<event event="HELD">
						</event>
						<event event="FAILED">
						</event>
						<event event="ORIGINATED" cond="cmp(_event.originated.connection,consultationNewCall)">
						</event>
						<event event="DELIVERED" cond="cmp(_event.originated.connection,consultationNewCall)">
							<transition target="consultationDelivered"/>
						</event>
						<event event="ConsultationCall" >
							<send target="this" type="notify" dest="client" event="agentconsult">
								<type>agentconsult</type>
								<status type="script">_event.ConsultationCall.cause;</status>
								<reason type="script">_event.ConsultationCall.reason; </reason>
							</send>
							<script>consultationNewCall = _event.ConsultationCall.newCall;</script>
							<transition  cond = "_event.ConsultationCall.cause != 0" target="established"/>
						</event>
						<event event="cmd" cond="_event.cmd=='agentconsultback'">
							<send target="this" type="cmd" dest="this" event="ReconnectCall">
								<activeCall type="script">consultationNewCall;</activeCall>
								<heldCall type="script">connection;</heldCall>
							</send>
							<transition target="consultationReconnecting"/>
						</event>
						<event event="CONNECTION_CLEARED" cond="cmp(_event.connectionCleared.connection,consultationNewCall)">
						</event>
						<event event="cmd" cond="_event.cmd=='cancelmakecall'">
							<send target="this" type="cmd" dest="this" event="ClearCall">
								<connection type="script">connection;</connection>
							</send>
							<send target="this" type="cmd" dest="this" event="ClearCall">
								<connection type="script">consultationNewCall;</connection>
							</send>
						</event>

						<event event="RETRIEVED" >
							<transition cond="cmp(_event.retrieved.connection, connection)" target="established"/>
						</event>
						<state id="consultationDelivered">
							<event event="ESTABLISHED" cond="_event.established.connection.callID == consultationNewCall.callID">
								<send target="this" type="notify" dest="client" event="consultationcalls">
									<type>consultationcalls</type>
									<status type="script">_event.established.cause;</status>
									<reason type="script">_event.established.reason; </reason>
								</send>
								<transition target="consultationed"/>
							</event>
							<state id="consultationed">
								<event event="cmd" cond="_event.cmd=='agentshift'">
									<send target="this" type="cmd" dest="this" event="TransferCall">
										<activeCall type="script">consultationNewCall;</activeCall>
										<heldCall type="script">connection;</heldCall>
									</send>
								</event>
								<event event="TransferCall">
								</event>
								<event event="TRANSFERRED">
									<transition target="ACW"/>
								</event>
								<event event="cmd" cond="_event.cmd=='tripartitetalk'">
									<send target="this" type="cmd" dest="this" event="ConferenceCall">
										<activeCall type="script">consultationNewCall;</activeCall>
										<heldCall type="script">connection;</heldCall>
									</send>
								</event>
								<event event="ConferenceCall" cond="_event.ConferenceCall.cause == 0">
									<script>conferenceCall = _event.ConferenceCall.newCall;</script>
								</event>
								<event event="CONFERENCED">
									<send target="this" type="notify" dest="client" event="tripartitetalk">
										<type>tripartitetalk</type>
										<status type="script">0;</status>
										<reason type="script">''; </reason>
									</send>
									<transition target="conferenced"/>
								</event>
							</state>
						</state>
						<state id="consultationReconnecting">
							<event event="ReconnectCall">
								<send target="this" type="notify" dest="client" event="agentconsultback">
									<type>agentconsultback</type>
									<status type="script">_event.ReconnectCall.cause;</status>
									<reason type="script">_event.ReconnectCall.reason; </reason>
								</send>
							</event>
							<event event="CONNECTION_CLEARED" cond="cmp(_event.connectionCleared.connection,consultationNewCall)">
							</event>
						</state>
					</state>
					<state id="helding">
						<event event="cmd" cond="_event.cmd=='mute'">
						</event>
						<event event="HoldCall" cond = "_event.HoldCall.cause != 0">
							<send target="this" type="notify" dest="client" event="mute">
								<type>mute</type>
								<status type="script">_event.HoldCall.cause;</status>
								<reason type="script">_event.HoldCall.reason; </reason>
							</send>
							<transition target="established"/>
						</event>
						<event event="HELD" cond="cmp(_event.held.connection,connection)">
							<send target="this" type="notify" dest="client" event="mute">
								<type>mute</type>
								<status type="script">0</status>
							</send>
							<transition target="held"/>
						</event>
						<state  id="held">
							<event event="cmd" cond="_event.cmd=='unmute'">
								<send target="this" type="cmd" dest="this" event="RetrieveCall">
									<connection type="script">connection;</connection>
								</send>
								<transition target="retrieveCalling"/>
							</event>
							<state id="retrieveCalling">
								<event event="cmd" cond="_event.cmd=='unmute'">
								</event>
								<event event="RetrieveCall" cond = "_event.RetrieveCall.cause != 0">
									<send target="this" type="notify" dest="client" event="unmute">
										<type>unmute</type>
										<status type="script">_event.RetrieveCall.cause;</status>
										<reason type="script">_event.RetrieveCall.reason; </reason>
									</send>
									<transition target="held"/>
								</event>
								<event event="RETRIEVED" cond="cmp(_event.retrieved.connection,connection)">
									<send target="this" type="notify" dest="client" event="unmute">
										<type>unmute</type>
										<status type="script">0</status>
									</send>
									<transition target="established"/>
								</event>
							</state>
						</state>
					</state>
					<state id="conferenced">
						<event event="cmd" cond="_event.cmd=='cancelmakecall'">
							<send target="this" type="cmd" dest="this" event="ClearCall">
								<connection type="script">conferenceCall;</connection>
							</send>
						</event>
						<event event="CONNECTION_CLEARED" cond="cmp(_event.connectionCleared.connection,conferenceCall)">
							<transition target="ACW"/>
						</event>
						<event event="CALL_CLEARED">
							<transition cond="cmp(_event.callCleared.connection,conferenceCall)" target="ACW"/>
						</event>
					</state>
				</state>
			</state>
		</state>

		<state id="logouting">
			<event event="AgentLogout">
				<transition  target="final"/>
			</event>
			<event event=".*">
				<log level="warn" type="script">_state._id + " not process event "+_event._name;</log>
			</event>
		</state>
    </state>
	<state id="final">
		<onentry>
			<send target="this" type="notify" dest="extension" event="AgentLogout">
				<event>AgentLogout</event>
				<AgentLogout type="script">var agentId={};agentId.agentId = _agent.AgentId; agentId;</AgentLogout>
				<extension type="script">_agent.Extension</extension>
			</send>
		</onentry>
	</state>
</fsm>

