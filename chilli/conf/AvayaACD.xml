<?xml version="1.0" ?>
<fsm name ="AvayaACD" initial="Idle">
<datamodel>
	<data id="groupArray" expr='new Array();'/>
	<data id="monitorId"/>
</datamodel>

<state id="init">
	<event event="GroupControl">
		<script>groupArray.push(_event.GroupControl.originate);</script>
		<send target="this" type="notify" dest="extension" event="StateChange">
			<event>StateChange</event>
			<extension type="script">groupArray;</extension>
			<StateChange type="script">var StateChange = {}; StateChange.extension = _extension.Extension;StateChange.state=_state._id;StateChange;</StateChange>
		</send>
	</event>
	
	<state id="Idle">
		<onentry>
			<send target="this" type="notify" dest="extension" event="StateChange">
				<event>StateChange</event>
				<extension type="script">groupArray;</extension>
				<StateChange type="script">var StateChange = {}; StateChange.extension = _extension.Extension;StateChange.state=_state._id;StateChange;</StateChange>
			</send>
		</onentry>
		<event event= "DELIVERED">
			<send target="this" type="cmd" dest="this" event="MonitorCall">
				<connection type="script">_event.delivered.connection;</connection>
			</send>
			<transition target="Busy"/>
		</event>
	</state>
	
	<state id="Busy">
		<onentry>
			<send target="this" type="notify" dest="extension" event="StateChange">
				<event>StateChange</event>
				<extension type="script">groupArray;</extension>
				<StateChange type="script">var StateChange = {}; StateChange.extension = _extension.Extension;StateChange.state=_state._id;StateChange;</StateChange>
			</send>
		</onentry>
		<event event= "DELIVERED" cond="_event.monitorId != monitorId">
			<send target="this" type="notify" dest="extension" event="FAILED">
				<event>FAILED</event>
				<extension type="script">_event.from;</extension>
				<failed type="script">var failed={}; failed.reason='Busy'; failed;</failed>
			</send>
		</event>
		<event event="MonitorCall">
			<script>monitorId = _event.MonitorCall.monitorId;</script>
			<transition cond="_event.MonitorCall.status !=0" target="Idle"/>
		</event>
		<event event="MONITOR_ENDED">
			<transition target="Idle"/>
		</event>
	</state>
	
</state>

</fsm>

