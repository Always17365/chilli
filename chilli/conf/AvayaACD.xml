<?xml version="1.0" ?>
<fsm name ="AvayaACD" initial="init" final="Idle">
<datamodel>
	<data id="monitorId"/>
	<data id="callUUID"/>
	<data id="connection"/>
	<data id="agentId"/>
	<data id="caller"/>
	<data id="called"/>
	<data id="origcaller"/>
	<data id="origcaller"/>
	<data id="timestamp"/>
	<data id="starttime"/>
</datamodel>
<scriptmodel>
	<script src="./conf/uuid.js" />
</scriptmodel>
<state id="init">
	
	<event event= "DELIVERED">
		<script>connection = _event.delivered.connection; callUUID = uuid(); timestamp = Date.parse(new Date())/1000; starttime = Date.parse(new Date())/1000;caller= _event.delivered.calling; origcaller = caller; called = _event.delivered.called; origcalled = called;</script>
		
		<send fromexpr="_extension.Extension" target="mysql" type="cmd" dest="mysql"  event="sql">
			<sql type="script">var sql='INSERT INTO call_cdr'+
			'(id,                     callid,                      device,                    companyid,                   caller,           called,           origcaller,        origcalled,      start_stamp) VALUES'+
			'(\'' + callUUID+'\',\''+ connection.callID +'\',\'' + connection.deviceID+ '\',' + _event.companyid + ',\'' + caller+ '\',\'' + called + '\',\''+ caller + '\',\'' + called + '\',' + timestamp +')'; 
			sql;</sql>
		</send>
		<transition target="Busy"/>
	</event>
	
	<state id="Idle">
		<onentry>
			<send target="this" type="notify" dest="extension" event="StateChange">
				<event>StateChange</event>
				<extension type="script">_extension.Groups;</extension>
				<StateChange type="script">var StateChange = {}; StateChange.extension = _extension.Extension;StateChange.state=_state._id;StateChange;</StateChange>
			</send>
		</onentry>
	</state>
	
	<state id="Busy">
		<onentry>
			<send target="this" type="notify" dest="extension" event="StateChange">
				<event>StateChange</event>
				<extension type="script">_extension.Groups;</extension>
				<StateChange type="script">var StateChange = {}; StateChange.extension = _extension.Extension;StateChange.state=_state._id;StateChange;</StateChange>
			</send>
		</onentry>
		<event event= "DELIVERED" cond="_event.monitorId != monitorId">
			<send target="this" type="notify" dest="extension" event="FAILED">
				<event>FAILED</event>
				<extension type="script">_event.from;</extension>
				<failed type="script">var failed={}; failed.reason='Busy'; failed;</failed>
			</send>
		</event>
		<event event= "DELIVERED">
		</event>

		<event event="CALL_CLEARED">
			<transition target="Idle"/>
		</event>
	</state>
	
</state>

</fsm>

