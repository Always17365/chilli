<?xml version="1.0" ?>
<fsm name ="AvayaACD" initial="init" final="Idle">
<datamodel>
	<data id="monitorId"/>
	<data id="callUUID"/>
	<data id="connection"/>
</datamodel>
<scriptmodel>
	<script src="./conf/uuid.js" />
</scriptmodel>
<state id="init">
	
	<event event= "DELIVERED">
		<send target="this" type="cmd" dest="this" event="MonitorCall">
			<connection type="script">_event.delivered.connection;</connection>
		</send>
		<script>connection = _event.delivered.connection;</script>
		<transition target="Busy"/>
	</event>
	
	<state id="Idle">
		<onentry>
			<send target="this" type="notify" dest="extension" event="StateChange">
				<event>StateChange</event>
				<extension type="script">_extension.Groups;</extension>
				<StateChange type="script">var StateChange = {}; StateChange.extension = _extension.Extension;StateChange.state=_state._id;StateChange;</StateChange>
			</send>
		</onentry>
	</state>
	
	<state id="Busy">
		<onentry>
			<script>callUUID = uuid();</script>
			<send fromexpr="_extension.Extension" target="mysql" type="cmd" dest="mysql"  event="sql">
				<sql type="script">var sql='INSERT INTO call_cdr(id,callid,device,companyid) VALUES(\'' + callUUID+'\',\''+ connection.callID +'\',\'' + connection.deviceID+ '\','+_event.companyid+')'; sql;</sql>
			</send>
			<send target="this" type="notify" dest="extension" event="StateChange">
				<event>StateChange</event>
				<extension type="script">_extension.Groups;</extension>
				<StateChange type="script">var StateChange = {}; StateChange.extension = _extension.Extension;StateChange.state=_state._id;StateChange;</StateChange>
			</send>
		</onentry>
		<event event= "DELIVERED" cond="_event.monitorId != monitorId">
			<send target="this" type="notify" dest="extension" event="FAILED">
				<event>FAILED</event>
				<extension type="script">_event.from;</extension>
				<failed type="script">var failed={}; failed.reason='Busy'; failed;</failed>
			</send>
		</event>
		<event event="MonitorCall">
			<script>monitorId = _event.MonitorCall.monitorId;</script>
			<transition cond="_event.MonitorCall.status !=0" target="Idle"/>
		</event>
		<event event="MONITOR_ENDED">
			<transition target="Idle"/>
		</event>
	</state>
	
</state>

</fsm>

