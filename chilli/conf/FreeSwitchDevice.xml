<?xml version="1.0" ?>

<fsm name ="FreeSwitchDevice" initial="Null" final="Destroy">
<datamodel>
	<data id="status"/>
	<data id="oricalled" expr="null"/>
	<data id="oricaller" expr="null"/>
	<data id="called" expr="null" />
	<data id="caller" expr="null"/>
</datamodel>
<scriptmodel>
	<script src="./conf/uuid.js" />
	<script src="./conf/DateFormat.js"/>
</scriptmodel>
	<state id="Null">
		<event event="CHANNEL_CREATE">
		    <script>sessionID = _event.sessionID; caller = _event.CallerOrigCallerIDName; called =_event.CallerDestinationNumber;</script>
			<transition target="Initiated"/>
		</event>
		<event event="CHANNEL_DESTROY">
			<send cond="_state._id == 'Null'" target="call001" type="event" destexpr="_event.sessionID" event="Failed">
				<cause type="script">606</cause>
				<msg>USER_NOT_REGISTERED</msg>
				<deviceID type="script">_device.deviceID</deviceID>
				<sessionID type="script">_sessionid</sessionID>
			</send>
			<transition target="Destroy"/>
		</event>
		<event event="CHANNEL_ANSWER">
			<transition target="Connected"/>
		</event>
		
		<event event="CHANNEL_HANGUP">
			<send target="this" type="notify" destexpr="_device.AgentID" event="CONNECTION_CLEARED">
				<connectionCleared type="script">var param ={}; param.connection={}; param.connection.callID = sessionID;param;</connectionCleared>
			</send>
			<send target="call001" type="notify" destexpr="sessionID" event="CONNECTION_CLEARED">
				<connectionCleared type="script">var param ={}; param.connection={}; param.connection.sessionID = sessionID; param.deviceID = _device.deviceID; param;</connectionCleared>
			</send>
			<transition target="Null"/>
		</event>
		
		<state id="Initiated">
			<onentry>
				<send target="eventreport" type="notify" dest="eventreport" event="ServiceInitiated">
				</send>
				<send target="this" type="notify" destexpr="_device.AgentID" event="SERVICE_INITIATED">
					<serviceInitiated type="script">var param ={}; param.connection={}; param.connection.callID = sessionID;param;</serviceInitiated>
				</send>
				<send target="call001" type="notify" destexpr="sessionID" event="SERVICE_INITIATED">
					<serviceInitiated type="script">var param ={}; param.connection={}; param.connection.sessionID = sessionID; param.deviceID = _device.deviceID; param;</serviceInitiated>
				</send>
			</onentry>
			<event event="CHANNEL_PROGRESS">
			    <script>sessionID = _event.sessionID; caller = _event.CallerOrigCallerIDName; called =_event.CallerDestinationNumber;</script>
				<transition target="Alerting"/>
			</event>
		</state>
		<state id="Alerting">
			<onentry>
			</onentry>
		</state>
		<state id="Queued">
		</state>
		<state id="Failed">
		</state>
		<state id="Connected">
			<onentry>
			</onentry>
			<event event="CHANNEL_BRIDGE">
				<send target="this" type="notify" destexpr="_device.AgentID" event="ESTABLISHED">
					<established type="script">var param ={}; param.connection={}; param.connection.callID = sessionID; param.called = called; param.recordfilename = recordfilename; param;</established>
				</send>
			</event>
			<state id="Held">
			</state>
		</state>
    </state>
	<state id="Destroy">
		<onentry>
		</onentry>
	</state>
</fsm>

