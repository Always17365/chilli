<?xml version="1.0" ?>

<fsm name ="Call" initial="Null" final="Destroy">
<datamodel>
	<data id="status"/>
	<data id="caller"/>
	<data id="called"/>
	<data id="connectionID"/>
	<data id="callID"/>
</datamodel>
<scriptmodel>
	<script src="./conf/uuid.js" />
	<script src="./conf/DateFormat.js"/>
</scriptmodel>
	<state id="Null">
		<event event="MakeCall">
			<script>caller = _event.param.callingDevice; called = _event.param.calledDirectoryNumber; connectionID = _event.param.initiatedCall.connectionID; callID = _event.param.initiatedCall.callID;</script>
			<send target="freeswitch001" type="cmd" destexpr="_event.param.callingDevice" event="MakeCall">
				<caller type="script">_event.param.callingDevice</caller>
				<called type="script">_event.param.calledDirectoryNumber</called>
				<display type="script">_event.param.callingDevice</display>
				<sessionID type="script">_event.param.initiatedCall.sessionID</sessionID>
			</send>
		</event>
		<event event="Failed">
			<send target="eventreport" type="event" event="Failed">
				<failedConnection type="script">var param ={}; param.connectionID=connectionID; param.callID=callID;param.sessionID=_event.param.sessionID; param.deviceID=_event.param.deviceID; param;</failedConnection>
				<failingDevice type="script">_event.param.deviceID</failingDevice>
				<calledDevice type="script">called</calledDevice>
				<cause type="script">_event.param.cause</cause>
			</send>
			
			<transition target="Blocked"/>
		</event>
		<event event="Initiated">
			<send target="eventreport" type="event" event="ServiceInitiated">
				<initiatedConnection type="script">var param ={}; param.connectionID=connectionID; param.callID=callID;param.sessionID=_event.param.sessionID; param.deviceID=_event.param.deviceID; param;</initiatedConnection>
				<initiatingDevice type="script">_event.param.deviceID</initiatingDevice>
			</send>
			<transition target="Pending"/>
		</event>
		<state id="Pending">
			<onentry>
			</onentry>
		</state>
		<state id="Alerting">
		</state>
		<state id="Received">
		</state>
		<state id="Received-OnHold">
		</state>
		<state id="Delivered">
		</state>
		<state id="Established">
		</state>
		<state id="Failed">
		</state>
		<state id="Established-OnHold">
		</state>
		<state id="Originated">
		</state>
		<state id="Queued">
		</state>
		<state id="Blocked">
			<event event="Null">
				<send target="eventreport" type="event" event="ConnectionCleared">
					<droppedConnection type="script">var param ={}; param.connectionID=connectionID; param.callID=callID;param.sessionID=_event.param.sessionID; param.deviceID=_event.param.deviceID; param;</droppedConnection>
					<releasingDevice type="script">caller</releasingDevice>
				</send>
				<transition target="Destroy"/>
			</event>
			
		</state>
		<state id="Delivered-Held">
		</state>
		<state id="Established-Held">
		</state>
		<state id="Failed-Held">
		</state>
		<state id="Queued-Held">
		</state>
    </state>
	<state id="Destroy">
		<onentry>
			<send target="eventreport" type="event" event="CallCleared">
				<clearedCall type="script">var param ={}; param.connectionID=connectionID; param.callID=callID; param.deviceID=caller; param;</clearedCall>
			</send>
		</onentry>
	</state>
</fsm>

