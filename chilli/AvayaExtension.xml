<?xml version="1.0" ?>

<fsm name ="AvayaExtension" initial="init">
<datamodel>
	<data id="monitorId"/>
	<data id="agentId" expr="''"/>
</datamodel>
<scriptmodel>
</scriptmodel>
	<state id="init">
		<onentry>
		</onentry>
		<event event="ACS_OPEN_STREAM_CONF" cond="_event.OpenStream.status==0">
			<send target="this" type="cmd" dest="this" event="MonitorDevice">
				<deviceId type="script">_avaya.Extension</deviceId>
			</send>
		</event>
		<event event="MonitorDevice">
			<script>monitorId=_event.monitorId;</script>
			<!--timer idexpr="_extension.Extension" interval="10000"/-->
		</event>
		<event event="AgentLogin" cond="agentId == ''">
			<script>agentId = _event.AgentLogin.agentId;</script>
		</event>
		<event event="AgentLogin">
			<send target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<extension type="script">_event.agentId;</extension>
				<AgentLogin type="script">_event.AgentLogin.status = 1; _event.AgentLogin;</AgentLogin>
			</send>
		</event>
		<event event="AgentLogout" cond="agentId == _event.AgentLogout.agentId">
			<script>agentId = '';</script>
		</event>
		<event event ="DELIVERED">
			<send cond ="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<extension type="script">agentId;</extension>
				<monitorId type="script">_event.monitorId;</monitorId>
				<delivered type="script">_event.delivered;</delivered>
			</send>
		</event>
		<event event ="ESTABLISHED">
			<send cond ="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<extension type="script">agentId;</extension>
				<monitorId type="script">_event.monitorId;</monitorId>
				<established type="script">_event.established;</established>
			</send>
		</event>
		<event event ="CONNECTION_CLEARED" cond="_event.connectionCleared.localConnect == 'Null'">
			<send cond ="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<extension type="script">agentId;</extension>
				<monitorId type="script">_event.monitorId;</monitorId>
				<connectionCleared type="script">_event.connectionCleared;</connectionCleared>
			</send>
		</event>
		<!--event event="timer">
			<log level="debug" type="script">_event.id;</log>
			<send target="this" type="cmd" dest="this" event="MonitorStop">
				<monitorId type="script">monitorId</monitorId>
			</send>
		</event-->
    </state>
</fsm>

