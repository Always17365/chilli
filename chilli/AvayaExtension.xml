<?xml version="1.0" ?>

<fsm name ="AvayaExtension" initial="init">
<datamodel>
	<data id="monitorId"/>
	<data id="agentId" expr="''"/>
</datamodel>
<scriptmodel>
	<script>
		var localConnctionState = {
			csNone:-1,
			csNull:0,
			csInitiate:1,
			csAlerting:2,
			csConnect:3,
			csHold:4,
			csQueued:5,
			csFail:6
		};
	</script>
	<script>
		var ErrorCause = {
			ResourcesBusy:1
		};
	</script>
</scriptmodel>
	<state id="init">
		<onentry>
		</onentry>
		<event event="ACS_OPEN_STREAM_CONF" cond="_event.status==0">
			<send target="this" type="cmd" dest="this" event="MonitorDevice">
				<deviceId type="script">_avaya.Extension</deviceId>
			</send>
		</event>
		<event event="MonitorDevice">
			<script>monitorId=_event.monitorId;</script>
			<!--timer idexpr="_extension.Extension" interval="10000"/-->
		</event>
		<event event="AgentLogin" cond="agentId == ''">
			<script>agentId = _event.agentId;</script>
		</event>
		<event event="AgentLogin">
			<send target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<agentId type="script">_event.agentId;</agentId>
				<extension type="script">_event.agentId;</extension>
				<status type="script">ErrorCause.ResourcesBusy;</status>
			</send>
		</event>
		<event event="AgentLogout" cond="agentId == _event.agentId">
			<script>agentId = '';</script>
		</event>
		<event event ="CSTA_DELIVERED">
			<send cond ="agentId != ''" target="this" type="notify" dest="agent" eventexpr="_event._name">
				<event type="script">_event._name;</event>
				<agentId type="script">agentId;</agentId>
				<extension type="script">agentId;</extension>
				<called type="script">_event.called;</called>
				<calling type="script">_event.calling;</calling>
			</send>
		</event>
		
		<!--event event="timer">
			<log level="debug" type="script">_event.id;</log>
			<send target="this" type="cmd" dest="this" event="MonitorStop">
				<monitorId type="script">monitorId</monitorId>
			</send>
		</event-->
    </state>
</fsm>

